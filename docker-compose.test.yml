version: '3.8'

services:
  app_test:
    build:
      context: .
      dockerfile: Dockerfile
    command: pytest tests/ -v
    environment:
      - DATABASE_URL=postgresql+asyncpg://test_user:test_password@db_test:5432/test_db
      - TEST_DATABASE_URL=postgresql+asyncpg://test_user:test_password@db_test:5432/test_db
      - REDIS_URL=redis://redis_test:6379/0
      - CELERY_BROKER_URL=redis://redis_test:6379/1
      - CELERY_RESULT_BACKEND=redis://redis_test:6379/2
      - SECRET_KEY=test-secret-key-123
      - JWT_SECRET_KEY=test-jwt-key-123
      - ACCESS_TOKEN_EXPIRE_MINUTES=11520
    depends_on:
      db_test:
        condition: service_healthy
      redis_test:
        condition: service_healthy

  db_test:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_password
      - POSTGRES_DB=test_db
    # Use tmpfs for faster I/O since persistence isn't needed
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U test_user -d test_db" ]
      interval: 2s
      timeout: 2s
      retries: 10

  redis_test:
    image: redis:7-alpine
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 2s
      timeout: 2s
      retries: 5
