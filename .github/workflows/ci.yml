name: ðŸš€ YDTT CI/CD Pipeline

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ------------------------------------------------------------------
  # Job 1: Build & Test (Integration Tests in Docker)
  # ------------------------------------------------------------------
  build-and-test:
    name: ðŸ§© Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ðŸ§ª Run Integration Tests
        # Runs the full test suite inside Docker containers defined in docker-compose.test.yml
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from app_test

  # ------------------------------------------------------------------
  # Job 2: Build & Push Docker Image (Only on Main push)
  # ------------------------------------------------------------------
  build-and-push:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Set lowercase image name
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ------------------------------------------------------------------
  # Job 3: Deploy to Production (Only on Main push)
  # ------------------------------------------------------------------
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸš€ Deploy with Docker
        env:
          HOST: ${{ secrets.SERVER_HOST }}
          USER: ${{ secrets.SERVER_USER }}
          DOMAIN: ${{ secrets.DOMAIN }}
          SSL_EMAIL: ${{ secrets.SSL_EMAIL }}
          # Database
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          # App secrets
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
          # Docker image
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FIRST_SUPERUSER: ${{ secrets.FIRST_SUPERUSER }}
          FIRST_SUPERUSER_PASSWORD: ${{ secrets.FIRST_SUPERUSER_PASSWORD }}
        run: |
          set -e
          echo "âœ… Preparing deployment files..."

          # Lowercase image tag
          export IMAGE_TAG=${REGISTRY}/${GITHUB_REPOSITORY,,}:latest
          # Use user provided domain or default to localhost if not set (fallback)
          export DOMAIN=${DOMAIN:-localhost}

          # Create .env file locally to copy to server
          cat > .env <<EOT
          DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
          SECRET_KEY=${SECRET_KEY}
          JWT_SECRET_KEY=${JWT_SECRET_KEY}
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_DB=${POSTGRES_DB}
          MINIO_ROOT_USER=${MINIO_ROOT_USER}
          MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
          IMAGE_TAG=${IMAGE_TAG}
          DOMAIN=${DOMAIN}
          FIRST_SUPERUSER=${FIRST_SUPERUSER}
          FIRST_SUPERUSER_PASSWORD=${FIRST_SUPERUSER_PASSWORD}
          EOT
          
          # Make scripts executable
          chmod +x deploy/deploy.sh

          echo "ðŸ“¦ Bundling files for optimized transfer..."
          # Create a temporary directory for bundling
          mkdir -p deploy_bundle/deploy
          
          # Move files to bundle
          cp docker-compose.prod.yml deploy_bundle/docker-compose.yml
          cp deploy/nginx.conf deploy_bundle/nginx.conf
          cp deploy/deploy.sh deploy_bundle/deploy.sh
          cp deploy/init-letsencrypt.sh deploy_bundle/init-letsencrypt.sh
          mv .env deploy_bundle/.env
          
          # Create tarball
          tar -czf deploy.tar.gz -C deploy_bundle .
          
          echo "ðŸ“‚ Copying deployment bundle to server..."
          # Function to copy with retry
          copy_with_retry() {
            local src=$1
            local dest=$2
            local max_attempts=5
            local attempt=1
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt of $max_attempts: Copying $src..."
              if scp -v -o StrictHostKeyChecking=no -o ConnectTimeout=60 $src $USER@$HOST:$dest; then
                echo "âœ… Successfully copied $src"
                return 0
              fi
              echo "âŒ Copy failed. Retrying in 5 seconds..."
              sleep 5
              ((attempt++))
            done
            echo "ðŸ”¥ Failed to copy $src after $max_attempts attempts"
            return 1
          }

          # Copy only the tarball
          copy_with_retry deploy.tar.gz /tmp/deploy.tar.gz

          echo "ðŸš€ Executing remote deployment script..."
          # Execute deploy script on server
          # 1. Extract tarball
          # 2. Run deploy script
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=30 $USER@$HOST "
            # Setup vars
            # NOTE: Ensure this directory exists and is owned by your user:
            # sudo mkdir -p /opt/ydtt-backend && sudo chown $USER:$USER /opt/ydtt-backend
            APP_DIR=/opt/ydtt-backend
            OLD_DIR=~/ydtt-backend
            
            # Prepare directory
            mkdir -p \$APP_DIR
            mkdir -p /tmp/deploy_extracted

            # Extract
            tar -xzf /tmp/deploy.tar.gz -C /tmp/deploy_extracted
            
            # Move to clean app dir location
            mv /tmp/deploy_extracted/docker-compose.yml \$APP_DIR/docker-compose.yml
            mv /tmp/deploy_extracted/nginx.conf \$APP_DIR/nginx.conf
            mv /tmp/deploy_extracted/.env \$APP_DIR/.env
            mv /tmp/deploy_extracted/deploy.sh \$APP_DIR/deploy.sh
            mv /tmp/deploy_extracted/init-letsencrypt.sh \$APP_DIR/init-letsencrypt.sh
            
            # Make init script executable
            chmod +x \$APP_DIR/init-letsencrypt.sh
            
            # Cleanup temp
            rm -rf /tmp/deploy_extracted /tmp/deploy.tar.gz
            
            # Cleanup old directory if it exists (one-time migration advice)
            if [ -d \"\$OLD_DIR\" ]; then
               echo \"âš ï¸ Found old deployment at \$OLD_DIR. You may safely delete it manually with 'rm -rf \$OLD_DIR' after verification.\"
            fi

            # Exec from correct dir
            cd \$APP_DIR
            bash deploy.sh '${GITHUB_TOKEN}' '${GITHUB_ACTOR}' '${DOMAIN}' '${SSL_EMAIL}'
          "
