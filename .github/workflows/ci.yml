name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ci-tests:
    runs-on: ubuntu-latest
    steps:
    # 1. Checkout the repository code to the runner
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Set up Docker Buildx
    # This installs the modern Docker builder, ensuring cache support and multi-platform capabilities if needed.
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # 3. Run Integration Tests
    # This step spins up the full test environment (Postgres, Redis, App) defined in docker-compose.test.yml.
    # It executes the tests inside the 'app_test' container.
    #
    # Flags explanation:
    #   docker compose: Uses the V2 plugin syntax (standard on GHA) instead of legacy 'docker-compose'.
    #   -f docker-compose.test.yml: Specifies the test configuration file.
    #   up: Creates and starts containers.
    #   --build: Forces a rebuild of the image to ensure the latest code changes are included.
    #   --abort-on-container-exit: Stops all containers (DB, Redis) as soon as the test container exits.
    #   --exit-code-from app_test: Uses the exit code of the test container (0=pass, 1=fail) to determine CI success.
    - name: Run Integration Tests
      run: |
        docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from app_test
